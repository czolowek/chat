import random
import re
from typing import Tuple, Set

from allGPT.base import BaseModule
from utils.text_processing import normalize_text

class IstoriyaModule(BaseModule):
    """Модуль для обработки запросов по теме 'История'"""
    
    def _init_keywords(self) -> Set[str]:
        """Инициализация ключевых слов для модуля истории"""
        return {
            'история', 'древний мир', 'средневековье', 'ренессанс',
            'просвещение', 'новое время', 'новейшая история', 'век',
            'эпоха', 'цивилизация', 'империя', 'государство', 'династия',
            'монархия', 'республика', 'революция', 'война', 'битва',
            'мировая война', 'холодная война', 'правитель', 'император',
            'король', 'царь', 'фараон', 'президент', 'диктатор',
            'исторический', 'археология', 'артефакт', 'хронология',
            'летопись', 'исторический период', 'древний рим', 'древняя греция',
            'россия', 'ссср', 'российская империя', 'русь'
        }
    
    def get_response(self, text: str, current_state: str) -> Tuple[str, str]:
        """
        Генерирует ответ на запрос пользователя по теме истории
        
        Args:
            text (str): Текст запроса пользователя
            current_state (str): Текущее состояние диалога
            
        Returns:
            Tuple[str, str]: Кортеж (ответ_бота, новое_состояние)
        """
        normalized_text = normalize_text(text)
        new_state = current_state
        
        # Проверка на короткие запросы
        if len(normalized_text) < 3:
            response = 'Пожалуйста, задайте более подробный вопрос по истории.'
            return response, new_state
        
        # Древний мир
        if any(phrase in normalized_text for phrase in ['древний мир', 'древность', 'античность']):
            response = ('Древний мир — период истории человечества с момента появления письменности '
                       '(около 3500 г. до н.э.) до падения Западной Римской империи (476 г. н.э.). '
                       'Основные цивилизации: Месопотамия, Древний Египет, Древняя Индия, '
                       'Древний Китай, Древняя Греция и Древний Рим. Этот период характеризуется '
                       'возникновением первых государств, развитием письменности, городов, '
                       'искусств и наук.')
            new_state = 'history_ancient'
            
        elif any(phrase in normalized_text for phrase in ['древняя греция', 'древнегреческий']):
            response = ('Древняя Греция — цивилизация, существовавшая на территории Греции, '
                       'островов Эгейского моря и побережья Малой Азии с XXX в. до н.э. до '
                       'завоевания Римом в 146 г. до н.э. Известна развитием демократии, '
                       'философии (Сократ, Платон, Аристотель), литературы, искусства, '
                       'Олимпийских игр. Крупнейшие города-государства: Афины, Спарта, Коринф.')
            new_state = 'history_ancient_greece'
            
        elif any(phrase in normalized_text for phrase in ['древний рим', 'римская империя']):
            response = ('Древний Рим — цивилизация, возникшая на Апеннинском полуострове '
                       'в VIII в. до н.э. и ставшая империей, охватывающей Средиземноморье '
                       'и часть Европы. Прошла путь от царства (753-509 гг. до н.э.) через '
                       'республику (509-27 гг. до н.э.) к империи (27 г. до н.э.-476 г. н.э.). '
                       'Создала выдающиеся достижения в области права, военного дела, архитектуры, '
                       'литературы, инженерии.')
            new_state = 'history_ancient_rome'
        
        # Средние века
        elif any(phrase in normalized_text for phrase in ['средневековье', 'средние века']):
            response = ('Средние века — период истории Европы и Ближнего Востока с V по XV вв., '
                       'от падения Западной Римской империи до начала эпохи Возрождения. '
                       'Характеризуется феодальным устройством, доминированием христианской церкви, '
                       'развитием рыцарства, возникновением городов-коммун и университетов. '
                       'Включает периоды Раннего (V-XI вв.), Высокого (XI-XIII вв.) и Позднего '
                       '(XIII-XV вв.) средневековья.')
            new_state = 'history_medieval'
        
        # Новое время
        elif any(phrase in normalized_text for phrase in ['новое время', 'эпоха возрождения', 'ренессанс']):
            if 'ренессанс' in normalized_text or 'возрождение' in normalized_text:
                response = ('Эпоха Возрождения (Ренессанс) — период в истории Европы XIV-XVI вв., '
                           'характеризующийся возрождением интереса к античной культуре, гуманизмом, '
                           'расцветом искусств и наук. Зародился в Италии (Данте, Петрарка, '
                           'Боккаччо, Леонардо да Винчи, Микеланджело, Рафаэль) и распространился '
                           'по Европе. Способствовал переходу от средневековья к Новому времени.')
                new_state = 'history_renaissance'
            else:
                response = ('Новое время — исторический период с XV-XVI до начала XX в., начавшийся '
                           'с эпохи Великих географических открытий и Возрождения. Характеризуется '
                           'формированием капитализма, абсолютных монархий, колониальных империй, '
                           'промышленной революцией, буржуазными революциями, распространением '
                           'просвещения и науки. Завершился Первой мировой войной и революциями '
                           'начала XX в.')
                new_state = 'history_modern'
        
        # Новейшее время
        elif any(phrase in normalized_text for phrase in ['новейшая история', 'современная история', 'xx век']):
            response = ('Новейшая история — период с 1914 г. (начало Первой мировой войны) по настоящее '
                       'время. Включает две мировые войны, Великую депрессию, холодную войну, '
                       'деколонизацию, научно-техническую революцию, глобализацию, информационную '
                       'революцию. Характеризуется противостоянием капиталистической и '
                       'социалистической систем, образованием и распадом СССР, ростом глобальных '
                       'проблем человечества.')
            new_state = 'history_contemporary'
            
        # Мировые войны
        elif 'первая мировая' in normalized_text:
            response = ('Первая мировая война (1914-1918) — один из крупнейших вооружённых конфликтов '
                       'в истории человечества. Основные участники: Антанта (Россия, Франция, '
                       'Великобритания, позже США) и Центральные державы (Германия, Австро-Венгрия, '
                       'Османская империя, Болгария). Причины: империалистические противоречия, '
                       'борьба за колонии и рынки сбыта. Итоги: распад четырёх империй, революции, '
                       'перекройка карты Европы, создание Лиги Наций.')
            new_state = 'history_ww1'
            
        elif 'вторая мировая' in normalized_text:
            response = ('Вторая мировая война (1939-1945) — крупнейший военный конфликт в истории '
                       'человечества. Основные участники: страны Оси (Германия, Италия, Япония) '
                       'и Антигитлеровская коалиция (СССР, США, Великобритания и др.). Причины: '
                       'политика нацистской Германии, нерешённые противоречия после Первой мировой '
                       'войны. Основные события: битва за Москву, Сталинградская битва, '
                       'высадка в Нормандии, атомные бомбардировки Японии. Итоги: поражение '
                       'стран Оси, создание ООН, начало холодной войны.')
            new_state = 'history_ww2'
        
        # История России
        elif any(word in normalized_text for word in ['россия', 'русь', 'российская', 'российский']):
            if 'киевская русь' in normalized_text:
                response = ('Киевская Русь — раннефеодальное государство восточных славян, '
                           'существовавшее с IX по XII вв. со столицей в Киеве. Основано, '
                           'согласно летописям, варяжским князем Рюриком, продолжено его '
                           'преемниками Олегом, Игорем, Ольгой, Святославом. Расцвет при '
                           'Владимире Святом (крещение Руси, 988 г.) и Ярославе Мудром. '
                           'Распалось на отдельные княжества в период феодальной раздробленности.')
                new_state = 'history_kievan_rus'
            elif 'российская империя' in normalized_text:
                response = ('Российская империя — государство, существовавшее с 1721 г. '
                           '(провозглашение Петром I) до Февральской революции 1917 г. '
                           'Была крупнейшим государством мира по территории. Правили императоры '
                           'из династий Романовых и Гольштейн-Готторп-Романовых. Ключевые события: '
                           'реформы Петра I и Екатерины II, Отечественная война 1812 г., '
                           'отмена крепостного права (1861), революция 1905-1907 гг.')
                new_state = 'history_russian_empire'
            elif 'ссср' in normalized_text or 'советский союз' in normalized_text:
                response = ('СССР (Союз Советских Социалистических Республик) — государство, '
                           'существовавшее с 1922 по 1991 гг. Образован на территории бывшей '
                           'Российской империи после Октябрьской революции 1917 г. и Гражданской '
                           'войны. Основные этапы: НЭП, индустриализация, коллективизация, '
                           'репрессии, Великая Отечественная война, послевоенное восстановление, '
                           'оттепель, застой, перестройка. Распался в 1991 г. на 15 независимых '
                           'государств.')
                new_state = 'history_ussr'
            else:
                response = ('История России охватывает период от восточнославянских племён '
                           'через Киевскую Русь, удельные княжества, Московское государство, '
                           'Российскую империю, СССР до современной Российской Федерации. '
                           'Какой период российской истории вас интересует?')
                new_state = 'history_russia_general'
        
        # Общие вопросы об истории
        elif 'что такое история' in normalized_text or 'объясни историю' in normalized_text:
            response = ('История — наука, изучающая прошлое человеческих обществ, их движение и '
                       'закономерности развития. Опирается на письменные источники, археологические '
                       'находки, устные предания, языковые данные и другие свидетельства. '
                       'Делится на периоды: первобытность, древний мир, средние века, '
                       'новое время, новейшее время. Также делится по регионам и странам. '
                       'Какой исторический период или регион вас интересует?')
            new_state = 'history_introduction'
            
        elif current_state == 'history_introduction':
            if 'древний мир' in normalized_text:
                response = ('Древний мир включает историю первых цивилизаций, возникших около '
                           'рек Нил, Тигр, Евфрат, Инд, Хуанхэ, а также античных Греции и Рима. '
                           'Этот период характеризуется появлением государств, письменности, '
                           'монументальной архитектуры, развитыми ремёслами, торговлей, '
                           'военным делом. О какой древней цивилизации вы хотите узнать больше?')
                new_state = 'history_ancient_civilizations'
            elif 'средневековье' in normalized_text:
                response = ('Средневековье — эпоха феодализма, рыцарства, распространения мировых '
                           'религий, крестовых походов, создания университетов. В Европе это '
                           'время от падения Рима до Ренессанса, в других регионах хронология '
                           'может отличаться. Что именно вас интересует в средневековой истории?')
                new_state = 'history_medieval_details'
            elif 'новое время' in normalized_text:
                response = ('Новое время началось с эпохи Великих географических открытий, '
                           'возникновения капитализма, колониальных империй. Включает Возрождение, '
                           'Реформацию, Просвещение, промышленную революцию, образование '
                           'национальных государств. Какие события этой эпохи вам интересны?')
                new_state = 'history_modern_details'
            else:
                response = ('История изучает развитие человечества от первобытности до наших дней. '
                           'Включает политическую историю, экономическую, социальную, '
                           'культурную, военную. Какой период или аспект истории вас '
                           'интересует больше всего?')
                new_state = 'history_introduction'
        
        else:
            # Случайные ответы на общие вопросы по истории
            general_responses = [
                'История помогает нам понять, как развивались общества и цивилизации. Какой исторический период вам интересен?',
                'Исторические события формируют современный мир. О каком историческом событии вы хотели бы узнать?',
                'От древних цивилизаций до современности — история полна интересных событий. Что вас интересует?',
                'История — это не только даты и факты, но и понимание причин и следствий. Какую тему вы хотите обсудить?',
                'Изучая прошлое, мы лучше понимаем настоящее. Какой аспект истории вас интересует?'
            ]
            response = random.choice(general_responses)
            new_state = 'history_general'
        
        return response, new_state
