# -*- coding: utf-8 -*-
import random
import re
from typing import Tuple, Set

from allGPT.base import BaseModule
from utils.text_processing import normalize_text

class KhimiyaModule(BaseModule):
    """Модуль для обработки запросов по теме 'Химия'"""
    
    def _init_keywords(self) -> Set[str]:
        """Инициализация ключевых слов для модуля химии"""
        return {
            'химия', 'элемент', 'вещество', 'реакция', 'атом',
            'молекула', 'периодическая система', 'менделеев',
            'кислота', 'щелочь', 'основание', 'соль', 'металл',
            'неметалл', 'оксид', 'гидроксид', 'катализатор',
            'валентность', 'окисление', 'восстановление', 'органическая',
            'неорганическая', 'полимер', 'белок', 'углевод', 'жир',
            'спирт', 'альдегид', 'кетон', 'карбоновая кислота',
            'эфир', 'аминокислота', 'углерод', 'водород', 'кислород',
            'азот', 'хлор', 'натрий', 'калий'
        }
    
    def get_response(self, text: str, current_state: str) -> Tuple[str, str]:
        """
        Генерирует ответ на запрос пользователя по теме химии
        
        Args:
            text (str): Текст запроса пользователя
            current_state (str): Текущее состояние диалога
            
        Returns:
            Tuple[str, str]: Кортеж (ответ_бота, новое_состояние)
        """
        normalized_text = normalize_text(text)
        new_state = current_state
        
        # Проверка на короткие запросы
        if len(normalized_text) < 3:
            response = 'Пожалуйста, задайте более подробный вопрос по химии.'
            return response, new_state
        
        # Периодическая система и элементы
        if any(phrase in normalized_text for phrase in ['периодическая система', 'таблица менделеева']):
            response = ('Периодическая система химических элементов (таблица Менделеева) — '
                       'классификация химических элементов, устанавливающая зависимость свойств '
                       'элементов от заряда атомного ядра. Современная таблица содержит 118 элементов, '
                       'расположенных в 7 периодах и 18 группах. Элементы в группах имеют сходные '
                       'химические свойства.')
            new_state = 'chemistry_periodic_table'
            
        # Кислоты, основания, соли
        elif 'кислота' in normalized_text:
            response = ('Кислота — химическое соединение, при диссоциации в водном растворе '
                       'образующее ионы водорода (H⁺). Кислоты имеют кислый вкус, изменяют цвет '
                       'индикаторов (лакмус становится красным), реагируют с металлами, оксидами '
                       'и гидроксидами металлов, солями более слабых кислот. Примеры: соляная кислота '
                       '(HCl), серная кислота (H₂SO₄), азотная кислота (HNO₃).')
            new_state = 'chemistry_acid'
            
        elif any(word in normalized_text for word in ['щелочь', 'основание', 'гидроксид']):
            response = ('Основания (гидроксиды) — соединения, содержащие гидроксид-ионы (OH⁻). '
                       'Щелочи — растворимые в воде основания. Основания имеют горький вкус, '
                       'мыльные на ощупь, изменяют цвет индикаторов (лакмус становится синим), '
                       'нейтрализуют кислоты. Примеры: гидроксид натрия (NaOH), гидроксид калия (KOH), '
                       'гидроксид кальция (Ca(OH)₂).')
            new_state = 'chemistry_base'
            
        elif 'соль' in normalized_text:
            response = ('Соль — химическое соединение, продукт замещения атома водорода в кислоте '
                       'на атом металла или замещения гидроксильной группы в основании на кислотный '
                       'остаток. Образуются при взаимодействии кислот с основаниями, металлами или '
                       'другими солями. Примеры: хлорид натрия (NaCl), сульфат меди (CuSO₄), '
                       'карбонат кальция (CaCO₃).')
            new_state = 'chemistry_salt'
        
        # Виды химических реакций
        elif 'химическая реакция' in normalized_text or 'виды реакций' in normalized_text:
            response = ('Химические реакции классифицируют по разным признакам:\n'
                       '1. По типу превращения: соединения, разложения, замещения, обмена.\n'
                       '2. По тепловому эффекту: экзотермические (выделение тепла), '
                       'эндотермические (поглощение тепла).\n'
                       '3. По наличию катализатора: каталитические, некаталитические.\n'
                       '4. По обратимости: обратимые, необратимые.\n'
                       '5. По изменению степеней окисления: окислительно-восстановительные, '
                       'не окислительно-восстановительные.\n'
                       'Какие реакции вас интересуют?')
            new_state = 'chemistry_reaction_types'
        
        # Виды химии
        elif 'органическая химия' in normalized_text:
            response = ('Органическая химия изучает соединения углерода с другими элементами '
                       '(органические соединения), их структуру, свойства, синтез и превращения. '
                       'Основные классы органических соединений: углеводороды, спирты, альдегиды, '
                       'кетоны, карбоновые кислоты, эфиры, амины, аминокислоты, белки, углеводы, '
                       'жиры. Органическая химия тесно связана с биохимией и лежит в основе многих '
                       'промышленных процессов.')
            new_state = 'chemistry_organic'
            
        elif 'неорганическая химия' in normalized_text:
            response = ('Неорганическая химия изучает все химические элементы и их соединения, '
                       'кроме большинства соединений углерода. Основные классы неорганических '
                       'веществ: оксиды, кислоты, основания, соли. Неорганическая химия исследует '
                       'свойства элементов, закономерности их соединения друг с другом, методы '
                       'получения и применение неорганических веществ.')
            new_state = 'chemistry_inorganic'
        
        # Общие вопросы о химии
        elif 'что такое химия' in normalized_text or 'объясни химию' in normalized_text:
            response = ('Химия — наука о веществах, их составе, строении, свойствах и превращениях. '
                       'Изучает атомы, молекулы, ионы, их сборки и взаимодействия. Основные разделы '
                       'химии: неорганическая, органическая, физическая, аналитическая и биохимия. '
                       'Химия тесно связана с физикой, биологией, медициной, материаловедением и '
                       'другими науками. Какой раздел химии вас интересует?')
            new_state = 'chemistry_introduction'
            
        elif current_state == 'chemistry_introduction':
            if 'органическая' in normalized_text:
                response = ('Органическая химия изучает соединения углерода. Это огромная область, '
                           'включающая более 60 миллионов известных соединений. Углеводороды, '
                           'спирты, кислоты, белки, жиры, углеводы — всё это органические вещества. '
                           'Что конкретно вас интересует?')
                new_state = 'chemistry_organic_details'
            elif 'неорганическая' in normalized_text:
                response = ('Неорганическая химия изучает свойства и реакции всех элементов и их '
                           'соединений, кроме большинства соединений углерода. Включает химию '
                           'металлов, неметаллов, кислот, оснований и солей. Какие именно вещества '
                           'или реакции вас интересуют?')
                new_state = 'chemistry_inorganic_details'
            elif 'аналитическая' in normalized_text:
                response = ('Аналитическая химия занимается разработкой методов определения '
                           'химического состава веществ и смесей. Включает качественный анализ '
                           '(какие элементы присутствуют) и количественный анализ (сколько каждого '
                           'элемента). Современные методы включают хроматографию, спектроскопию, '
                           'масс-спектрометрию и электрохимические методы.')
                new_state = 'chemistry_analytical'
            else:
                response = ('Химия включает множество областей: органическую, неорганическую, '
                           'физическую, аналитическую, биохимию, химию полимеров и другие. '
                           'Какая из них вас интересует больше всего?')
                new_state = 'chemistry_introduction'
        
        else:
            # Случайные ответы на общие вопросы по химии
            general_responses = [
                'Химия изучает вещества и их превращения. Какой аспект химии вас интересует?',
                'От атомов до сложных молекул — химия объясняет строение материального мира. Что бы вы хотели узнать?',
                'Химические реакции происходят постоянно вокруг нас. Какие процессы вас интересуют?',
                'Понимание химии помогает объяснить свойства веществ. О каких веществах вы хотите узнать?',
                'Химия — основа многих технологий и промышленных процессов. Какая область применения химии вас интересует?'
            ]
            response = random.choice(general_responses)
            new_state = 'chemistry_general'
        
        return response, new_state
