import random
import re
from typing import Tuple, Set
import math

from base import BaseModule
from utils.text_processing import normalize_text

class FizikaModule(BaseModule):
    """Модуль для обработки запросов по теме 'Физика'"""
    
    def __init__(self, name="fizika"):
        """Инициализация модуля физики"""
        super().__init__(name)
    
    def _init_keywords(self) -> Set[str]:
        """Инициализация ключевых слов для модуля физики"""
        return {
            'физика', 'механика', 'динамика', 'кинематика', 'энергия',
            'сила', 'масса', 'скорость', 'ускорение', 'гравитация',
            'электричество', 'магнетизм', 'оптика', 'термодинамика',
            'квантовая', 'релятивистская', 'атом', 'молекула', 'волна',
            'частица', 'фотон', 'электрон', 'протон', 'нейтрон',
            'тепло', 'температура', 'давление', 'объем', 'газ',
            'твердое тело', 'жидкость', 'закон ньютона', 'закон ома',
            'магнитное поле', 'электрическое поле', 'ядро', 'электромагнитное'
        }
    
    def get_response(self, text: str, current_state: str) -> Tuple[str, str]:
        """
        Генерирует ответ на запрос пользователя по теме физики
        
        Args:
            text (str): Текст запроса пользователя
            current_state (str): Текущее состояние диалога
            
        Returns:
            Tuple[str, str]: Кортеж (ответ_бота, новое_состояние)
        """
        normalized_text = normalize_text(text)
        new_state = current_state
        
        # Проверка на короткие запросы
        if len(normalized_text) < 3:
            response = 'Пожалуйста, задайте более подробный вопрос по физике.'
            return response, new_state
        
        # Механика и законы Ньютона
        if any(word in normalized_text for word in ['закон ньютона', 'законы ньютона']):
            if 'первый' in normalized_text or '1' in normalized_text:
                response = ('Первый закон Ньютона (закон инерции): тело сохраняет состояние покоя или '
                           'равномерного прямолинейного движения, если на него не действуют внешние силы '
                           'или их действие скомпенсировано.')
                new_state = 'physics_newton_first'
            elif 'второй' in normalized_text or '2' in normalized_text:
                response = ('Второй закон Ньютона: ускорение тела прямо пропорционально приложенной силе '
                           'и обратно пропорционально его массе. Математически: F = m·a, где F — сила, '
                           'm — масса, a — ускорение.')
                new_state = 'physics_newton_second'
            elif 'третий' in normalized_text or '3' in normalized_text:
                response = ('Третий закон Ньютона: силы, с которыми два тела действуют друг на друга, '
                           'равны по величине и противоположны по направлению.')
                new_state = 'physics_newton_third'
            else:
                response = ('Законы Ньютона — три основных закона классической механики:\n'
                           '1. Закон инерции: тело сохраняет состояние покоя или равномерного движения, '
                           'если на него не действуют силы.\n'
                           '2. F = m·a: ускорение прямо пропорционально силе и обратно пропорционально массе.\n'
                           '3. Действие равно противодействию: силы взаимодействия равны по величине и '
                           'противоположны по направлению.\n'
                           'О каком из них вы хотите узнать подробнее?')
                new_state = 'physics_newton_laws'
        
        # Электричество и закон Ома
        elif 'закон ома' in normalized_text:
            response = ('Закон Ома для участка цепи: сила тока прямо пропорциональна напряжению и обратно '
                       'пропорциональна сопротивлению. Формула: I = U/R, где I — сила тока (А), '
                       'U — напряжение (В), R — сопротивление (Ом).')
            new_state = 'physics_ohm_law'
        
        # Оптика и свет
        elif any(word in normalized_text for word in ['оптика', 'свет', 'преломление', 'отражение']):
            if 'преломление' in normalized_text:
                response = ('Закон преломления света (закон Снеллиуса): отношение синуса угла падения к синусу '
                           'угла преломления есть величина постоянная для двух сред: sin(α)/sin(β) = n₂/n₁, '
                           'где n₁ и n₂ — показатели преломления сред.')
                new_state = 'physics_refraction'
            elif 'отражение' in normalized_text:
                response = ('Закон отражения света: угол падения равен углу отражения, а падающий луч, '
                           'отраженный луч и перпендикуляр к поверхности в точке падения лежат в одной плоскости.')
                new_state = 'physics_reflection'
            else:
                response = ('Оптика изучает свойства и законы распространения света. Основные явления: '
                           'отражение (угол падения = углу отражения), преломление (sin(α)/sin(β) = n₂/n₁), '
                           'дисперсия (разложение света на спектр), дифракция и интерференция. '
                           'Какое явление вас интересует?')
                new_state = 'physics_optics'
        
        # Термодинамика
        elif any(word in normalized_text for word in ['термодинамика', 'тепло', 'температура']):
            if 'первый закон' in normalized_text or 'первое начало' in normalized_text:
                response = ('Первый закон термодинамики (закон сохранения энергии): изменение внутренней '
                           'энергии системы равно сумме совершенной над системой работы и переданного ей '
                           'количества теплоты: ΔU = Q + A.')
                new_state = 'physics_thermodynamics_first'
            elif 'второй закон' in normalized_text or 'второе начало' in normalized_text:
                response = ('Второй закон термодинамики утверждает, что тепло самопроизвольно переходит '
                           'только от горячего тела к холодному. Энтропия замкнутой системы не может уменьшаться.')
                new_state = 'physics_thermodynamics_second'
            else:
                response = ('Термодинамика изучает преобразования энергии, особенно тепловой, и работу. '
                           'Ключевые законы:\n'
                           '1. Первый закон термодинамики: закон сохранения энергии (ΔU = Q + A).\n'
                           '2. Второй закон термодинамики: энтропия замкнутой системы не уменьшается.\n'
                           '3. Третий закон термодинамики: энтропия идеального кристалла при абсолютном нуле равна нулю.\n'
                           'Какой аспект термодинамики вас интересует?')
                new_state = 'physics_thermodynamics'
        
        # Ответы на общие вопросы о физике
        elif 'что такое физика' in normalized_text or 'объясни физику' in normalized_text:
            response = ('Физика — наука о материи, её движении и поведении в пространстве и времени, '
                       'а также о связанных с этим энергии и силе. Основные разделы физики включают '
                       'механику, термодинамику, электромагнетизм, оптику, акустику, квантовую физику '
                       'и теорию относительности. Какой раздел физики вас интересует?')
            new_state = 'physics_introduction'
            
        elif current_state == 'physics_introduction':
            if 'механика' in normalized_text:
                response = ('Механика изучает движение тел и взаимодействие между ними. '
                           'Она делится на кинематику (описание движения), динамику (силы и их действие) '
                           'и статику (условия равновесия). Какой аспект механики вас интересует?')
                new_state = 'physics_mechanics'
            elif 'электромагнетизм' in normalized_text or 'электричество' in normalized_text:
                response = ('Электромагнетизм изучает электрические и магнитные явления. '
                           'Основные понятия включают электрический заряд, электрическое поле, '
                           'магнитное поле, электромагнитные волны. Хотите узнать о каком-то конкретном аспекте?')
                new_state = 'physics_electromagnetism'
            elif 'квантов' in normalized_text:
                response = ('Квантовая физика изучает поведение материи и энергии на атомном '
                           'и субатомном уровнях. Она объясняет явления, которые не могут быть объяснены '
                           'классической физикой, такие как дуализм волна-частица, туннельный эффект, '
                           'квантовая запутанность. Что конкретно вас интересует?')
                new_state = 'physics_quantum'
            else:
                response = ('Физика включает множество разделов: механика, термодинамика, '
                           'электромагнетизм, оптика, квантовая физика, теория относительности и другие. '
                           'Какой из них вас интересует больше всего?')
                new_state = 'physics_introduction'
        
        else:
            # Случайные ответы на общие вопросы по физике
            general_responses = [
                'Физика объясняет фундаментальные законы мироздания. Какой аспект вас интересует?',
                'Физические законы универсальны и выражаются на языке математики. Что конкретно вы хотите узнать?',
                'Физика помогает понять, как устроена Вселенная. Какой раздел физики вас интересует?',
                'Физика — наука, изучающая материю, энергию и их взаимодействие. О чём бы вы хотели узнать подробнее?',
                'От атомов до галактик, физика объясняет принципы работы мира. Какая тема вас интересует?'
            ]
            response = random.choice(general_responses)
            new_state = 'physics_general'
        
        return response, new_state