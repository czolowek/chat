import random
import re
from typing import Tuple, Set

from allGPT.base import BaseModule
from utils.text_processing import normalize_text

class GeografiyaModule(BaseModule):
    """Модуль для обработки запросов по теме 'География'"""
    
    def _init_keywords(self) -> Set[str]:
        """Инициализация ключевых слов для модуля географии"""
        return {
            'география', 'континент', 'материк', 'океан', 'море',
            'река', 'озеро', 'гора', 'вулкан', 'пустыня',
            'лес', 'тундра', 'саванна', 'джунгли', 'степь',
            'климат', 'погода', 'атмосфера', 'литосфера', 'гидросфера',
            'страна', 'город', 'столица', 'население', 'экономика',
            'ресурсы', 'полезные ископаемые', 'карта', 'глобус', 'широта',
            'долгота', 'рельеф', 'ландшафт', 'экватор', 'полюс',
            'тропики', 'природная зона', 'биосфера'
        }
    
    def get_response(self, text: str, current_state: str) -> Tuple[str, str]:
        """
        Генерирует ответ на запрос пользователя по теме географии
        
        Args:
            text (str): Текст запроса пользователя
            current_state (str): Текущее состояние диалога
            
        Returns:
            Tuple[str, str]: Кортеж (ответ_бота, новое_состояние)
        """
        normalized_text = normalize_text(text)
        new_state = current_state
        
        # Проверка на короткие запросы
        if len(normalized_text) < 3:
            response = 'Пожалуйста, задайте более подробный вопрос по географии.'
            return response, new_state
        
        # Континенты и материки
        if 'континент' in normalized_text or 'материк' in normalized_text:
            response = ('На Земле выделяют шесть континентов (материков): Евразия, Африка, '
                       'Северная Америка, Южная Америка, Австралия и Антарктида. '
                       'В некоторых классификациях Европу и Азию считают отдельными континентами, '
                       'тогда их семь. Самый большой — Евразия, самый маленький — Австралия. '
                       'Каждый континент обладает уникальным рельефом, климатом, флорой и фауной.')
            new_state = 'geography_continents'
            
        # Океаны
        elif 'океан' in normalized_text:
            response = ('Мировой океан делится на пять океанов: Тихий (самый большой), '
                       'Атлантический, Индийский, Южный (Антарктический) и Северный Ледовитый '
                       '(самый маленький). Океаны покрывают примерно 71% поверхности Земли. '
                       'Они играют важную роль в регулировании климата, круговороте воды, '
                       'являются средой обитания огромного количества видов и источником ресурсов.')
            new_state = 'geography_oceans'
        
        # Горы и вулканы
        elif 'гора' in normalized_text or 'горы' in normalized_text:
            response = ('Горы — участки земной поверхности, значительно приподнятые над '
                       'окружающими территориями. Образуются в результате тектонических движений '
                       'земной коры. Крупнейшие горные системы: Гималаи (с высочайшей вершиной '
                       'Эверест, 8848 м), Анды, Кордильеры, Альпы, Кавказ. Горы влияют на климат, '
                       'распределение осадков, формирование рек и озёр.')
            new_state = 'geography_mountains'
            
        elif 'вулкан' in normalized_text:
            response = ('Вулканы — геологические образования, через которые на поверхность '
                       'земли извергается магма, газы и пепел. Возникают в местах разломов '
                       'земной коры. Активные вулканы представляют опасность для близлежащих '
                       'территорий, но также формируют плодородные почвы. Известные вулканы: '
                       'Везувий, Этна, Фудзияма, Килиманджаро, Ключевская сопка.')
            new_state = 'geography_volcanoes'
        
        # Природные зоны
        elif any(word in normalized_text for word in ['природная зона', 'биом', 'экосистема']):
            response = ('Природные зоны (биомы) — крупные экосистемы, выделяемые по преобладающему '
                       'типу растительности и климатическим условиям. Основные природные зоны с '
                       'севера на юг: арктические пустыни, тундра, тайга, смешанные и '
                       'широколиственные леса, степи, пустыни, саванны, влажные экваториальные '
                       'леса (джунгли). В горах наблюдается высотная поясность.')
            new_state = 'geography_biomes'
        
        # Климат и погода
        elif 'климат' in normalized_text or 'погода' in normalized_text:
            response = ('Климат — многолетний режим погоды, характерный для определенной '
                       'территории. Основные климатические пояса: экваториальный, '
                       'субэкваториальный, тропический, субтропический, умеренный, '
                       'субарктический (субантарктический), арктический (антарктический). '
                       'На климат влияют широта, высота над уровнем моря, близость к океану, '
                       'рельеф, океанические течения.')
            new_state = 'geography_climate'
        
        # Страны и города
        elif 'страна' in normalized_text or 'государство' in normalized_text:
            response = ('В мире насчитывается 195 признанных независимых государств (193 члена ООН '
                       'плюс Ватикан и Палестина). Страны различаются по территории, населению, '
                       'государственному устройству, экономике, культуре. Самая большая по территории '
                       'страна — Россия, по населению — Китай, самое маленькое государство — Ватикан.')
            new_state = 'geography_countries'
            
        elif 'город' in normalized_text:
            response = ('Города — крупные населённые пункты с развитой инфраструктурой. '
                       'Крупнейшие города мира (агломерации): Токио, Дели, Шанхай, Сан-Паулу, '
                       'Мехико, Каир, Мумбаи, Пекин, Дакка, Осака. Города являются центрами '
                       'экономической, политической и культурной жизни, в них сосредоточено '
                       'более половины населения планеты.')
            new_state = 'geography_cities'
        
        # Общие вопросы о географии
        elif 'что такое география' in normalized_text or 'объясни географию' in normalized_text:
            response = ('География — наука о Земле, изучающая её поверхность, природу, население, '
                       'его хозяйственную деятельность и территориальную организацию. Делится на '
                       'физическую географию (изучает природные явления и объекты) и социально-'
                       'экономическую (изучает население, экономику, политическое устройство). '
                       'Какой аспект географии вас интересует?')
            new_state = 'geography_introduction'
            
        elif current_state == 'geography_introduction':
            if 'физическая' in normalized_text:
                response = ('Физическая география изучает географическую оболочку Земли и её компоненты: '
                           'литосферу (земная кора), гидросферу (водная оболочка), атмосферу (воздушная '
                           'оболочка), биосферу (живые организмы). Включает геоморфологию (рельеф), '
                           'климатологию, гидрологию, гляциологию, почвоведение и другие дисциплины. '
                           'Какая область физической географии вас интересует?')
                new_state = 'geography_physical'
            elif any(word in normalized_text for word in ['экономическая', 'социальная', 'политическая']):
                response = ('Социально-экономическая география изучает территориальную организацию '
                           'общества, включая размещение населения, хозяйства, политических систем. '
                           'Включает демографию, экономическую географию, политическую географию, '
                           'географию культуры и другие направления. Что конкретно вас интересует?')
                new_state = 'geography_human'
            elif 'карта' in normalized_text:
                response = ('Географические карты — уменьшенные обобщенные изображения земной '
                           'поверхности на плоскости с использованием условных знаков. Различают '
                           'общегеографические, тематические, топографические карты. Картография — '
                           'наука о создании и использовании карт. Современные карты создаются с '
                           'использованием геоинформационных систем (ГИС).')
                new_state = 'geography_cartography'
            else:
                response = ('География включает множество направлений: физическую (природа), '
                           'социально-экономическую (общество), картографию, страноведение, '
                           'региональную географию и другие. Какое из них вас интересует больше всего?')
                new_state = 'geography_introduction'
        
        else:
            # Случайные ответы на общие вопросы по географии
            general_responses = [
                'География изучает нашу планету во всём её разнообразии. Какой аспект вам интересен?',
                'От горных вершин до океанских глубин, география исследует все уголки Земли. Что бы вы хотели узнать?',
                'Земля — удивительно разнообразная планета. Какая географическая тема вас интересует?',
                'География помогает понять взаимосвязи между человеком и природой. Какой вопрос у вас есть?',
                'Каждый регион Земли уникален по-своему. О какой территории вы хотели бы узнать больше?'
            ]
            response = random.choice(general_responses)
            new_state = 'geography_general'
        
        return response, new_state
