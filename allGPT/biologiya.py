# -*- coding: utf-8 -*-
import random
import re
from typing import Tuple, Set

from allGPT.base import BaseModule
from utils.text_processing import normalize_text

class BiologiyaModule(BaseModule):
    """Модуль для обработки запросов по теме 'Биология'"""
    
    def _init_keywords(self) -> Set[str]:
        """Инициализация ключевых слов для модуля биологии"""
        return {
            'биология', 'клетка', 'организм', 'эволюция', 'ген',
            'днк', 'рнк', 'хромосома', 'белок', 'фермент', 'гормон',
            'нейрон', 'растение', 'животное', 'бактерия', 'вирус',
            'фотосинтез', 'экосистема', 'биосфера', 'метаболизм', 'размножение',
            'наследственность', 'мутация', 'естественный отбор', 'микроорганизм',
            'анатомия', 'физиология', 'цитология', 'ботаника', 'зоология',
            'эмбриология', 'таксономия', 'вид', 'популяция', 'орган'
        }
    
    def get_response(self, text: str, current_state: str) -> Tuple[str, str]:
        """
        Генерирует ответ на запрос пользователя по теме биологии
        
        Args:
            text (str): Текст запроса пользователя
            current_state (str): Текущее состояние диалога
            
        Returns:
            Tuple[str, str]: Кортеж (ответ_бота, новое_состояние)
        """
        normalized_text = normalize_text(text)
        new_state = current_state
        
        # Проверка на короткие запросы
        if len(normalized_text) < 3:
            response = 'Пожалуйста, задайте более подробный вопрос по биологии.'
            return response, new_state
        
        # Темы по ДНК, РНК, генетике
        if any(word in normalized_text for word in ['днк', 'дезоксирибонуклеиновая кислота']):
            response = ('ДНК (дезоксирибонуклеиновая кислота) — макромолекула, обеспечивающая хранение, '
                       'передачу и реализацию генетической программы организма. Состоит из двух цепей '
                       'нуклеотидов, закрученных в двойную спираль. Каждый нуклеотид содержит сахар дезоксирибозу, '
                       'фосфатную группу и одно из четырёх азотистых оснований: аденин (А), гуанин (Г), '
                       'цитозин (Ц) или тимин (Т).')
            new_state = 'biology_dna'
            
        elif any(word in normalized_text for word in ['рнк', 'рибонуклеиновая кислота']):
            response = ('РНК (рибонуклеиновая кислота) — одноцепочечная молекула нуклеиновой кислоты, '
                       'участвующая в реализации генетической информации. В отличие от ДНК, содержит '
                       'рибозу (вместо дезоксирибозы) и урацил (вместо тимина). Основные виды: '
                       'матричная РНК (мРНК), транспортная РНК (тРНК) и рибосомная РНК (рРНК).')
            new_state = 'biology_rna'
            
        elif 'ген' in normalized_text:
            response = ('Ген — участок ДНК, содержащий информацию для синтеза конкретного белка или РНК. '
                       'Гены определяют наследственные признаки организмов. Каждый ген содержит '
                       'инструкции для синтеза определённого белка или функциональной РНК, '
                       'которые выполняют конкретные функции в клетке.')
            new_state = 'biology_gene'
        
        # Клеточная биология
        elif 'клетка' in normalized_text:
            response = ('Клетка — основная структурная и функциональная единица всех живых организмов. '
                       'Выделяют два основных типа клеток: прокариотические (без оформленного ядра, '
                       'например бактерии) и эукариотические (с ядром, например клетки животных и растений). '
                       'Основные органеллы эукариотической клетки: ядро, митохондрии, эндоплазматический '
                       'ретикулум, аппарат Гольджи, лизосомы, пластиды (у растений).')
            new_state = 'biology_cell'
            
        # Эволюция и естественный отбор
        elif 'эволюция' in normalized_text or 'естественный отбор' in normalized_text:
            response = ('Эволюция — процесс постепенного изменения биологических видов с течением времени. '
                       'Теория эволюции путём естественного отбора, предложенная Чарльзом Дарвином, '
                       'объясняет, как организмы с благоприятными признаками имеют больше шансов выжить '
                       'и размножиться, передавая эти признаки следующим поколениям. Современная '
                       'синтетическая теория эволюции сочетает дарвиновский естественный отбор '
                       'с генетическими механизмами наследственности.')
            new_state = 'biology_evolution'
        
        # Фотосинтез
        elif 'фотосинтез' in normalized_text:
            response = ('Фотосинтез — процесс преобразования углекислого газа и воды в органические '
                       'соединения (преимущественно глюкозу) с использованием энергии света. '
                       'Происходит в хлоропластах растений и некоторых водорослей. '
                       'Упрощённое уравнение: 6CO₂ + 6H₂O + энергия света → C₆H₁₂O₆ + 6O₂. '
                       'В процессе выделяется кислород, необходимый для дыхания большинства организмов.')
            new_state = 'biology_photosynthesis'
        
        # Вирусы и бактерии
        elif 'вирус' in normalized_text:
            response = ('Вирусы — неклеточные инфекционные агенты, способные размножаться только '
                       'внутри клеток других организмов. Состоят из генетического материала (ДНК или РНК), '
                       'окружённого белковой оболочкой (капсидом), иногда с липидной мембраной. '
                       'Вирусы вызывают многие заболевания, от простуды до СПИДа и COVID-19.')
            new_state = 'biology_virus'
            
        elif 'бактери' in normalized_text:
            response = ('Бактерии — одноклеточные прокариотические микроорганизмы без оформленного ядра. '
                       'Имеют клеточную стенку, содержащую пептидогликан. Разнообразны по форме '
                       '(кокки, бациллы, спириллы) и метаболизму. Многие бактерии полезны для '
                       'экосистем и человека (пищеварение, азотфиксация), но некоторые вызывают '
                       'инфекционные заболевания.')
            new_state = 'biology_bacteria'
        
        # Общие вопросы о биологии
        elif 'что такое биология' in normalized_text or 'объясни биологию' in normalized_text:
            response = ('Биология — наука о живой природе, изучающая все аспекты жизни, в том числе '
                       'структуру, функционирование, рост, происхождение, эволюцию и распределение '
                       'живых организмов. Основные разделы биологии включают ботанику, зоологию, '
                       'микробиологию, экологию, генетику, молекулярную биологию, физиологию, '
                       'клеточную биологию и эволюционную биологию. Какой раздел биологии вас '
                       'интересует больше всего?')
            new_state = 'biology_introduction'
        
        elif current_state == 'biology_introduction':
            if 'ботаника' in normalized_text:
                response = ('Ботаника изучает растения, их строение, физиологические процессы, '
                           'классификацию, распространение и взаимодействие с окружающей средой. '
                           'Какой аспект растений вас интересует?')
                new_state = 'biology_botany'
            elif 'зоология' in normalized_text:
                response = ('Зоология — наука о животных, их строении, функциях, развитии, '
                           'распространении и классификации. Включает ихтиологию (рыбы), '
                           'герпетологию (рептилии и амфибии), орнитологию (птицы), '
                           'маммалогию (млекопитающие) и другие подразделы. '
                           'О каких животных вы хотите узнать больше?')
                new_state = 'biology_zoology'
            elif 'генетика' in normalized_text:
                response = ('Генетика изучает гены, генетическую изменчивость и наследственность '
                           'в живых организмах. Современная генетика включает молекулярную генетику, '
                           'популяционную генетику, количественную генетику и другие подобласти. '
                           'Что конкретно вас интересует в генетике?')
                new_state = 'biology_genetics'
            else:
                response = ('Биология охватывает множество областей: ботанику, зоологию, генетику, '
                           'экологию, физиологию, микробиологию и другие. Какая из них вас '
                           'интересует больше всего?')
                new_state = 'biology_introduction'
        
        else:
            # Случайные ответы на общие вопросы по биологии
            general_responses = [
                'Биология изучает всё живое — от микроскопических клеток до глобальных экосистем. Что именно вас интересует?',
                'Жизнь невероятно разнообразна и сложна. Какой аспект биологии вы хотели бы изучить?',
                'Биологические системы удивительно адаптивны. Какая область биологии вам наиболее интересна?',
                'От молекул ДНК до целых экосистем — биология изучает все уровни организации жизни. Что бы вы хотели узнать?',
                'Биология раскрывает секреты жизни на Земле. Какие биологические процессы или организмы вас интересуют?'
            ]
            response = random.choice(general_responses)
            new_state = 'biology_general'
        
        return response, new_state
